# Loutrack EM

**磁界ベースのドリフトレスVRトラッカー**

---

## TL;DR

IMUの積分ドリフト問題を解決するため、**磁界（EM）を使った絶対位置・姿勢トラッキング**を開発中。
VRChat等のフルボディトラッキング向け。現在M0（1軸PoC）フェーズ。

---

## 現在の進捗

| フェーズ | 内容 | 状態 |
|----------|------|------|
| **M0** | 1軸ディスクリートPoC | 🔄 電源＆受信アンプ組み立て完了、ADC接続中 |
| M1 | 3軸TDM | ⬜ |
| M1.5 | 自作コイル＆ドライバ強化 | ⬜ |
| M2 | SMD基板化（バッテリー駆動対応） | 🔄 バッテリー駆動仕様策定完了 |
| M3 | 推定アルゴリズム | ⬜ |
| M4 | 製品化 | ⬜ |

---

## なぜEMトラッキング？

### 既存技術の問題

| 方式 | 問題点 |
|------|--------|
| **IMU** | 積分ドリフトで数分〜数十分で位置がズレる |
| **光学式** | オクルージョン（遮蔽）に弱い、カメラ設置が必要 |
| **Lighthouse** | 高価、HMD依存、セットアップが複雑 |

### EMトラッキングの利点

- ✅ **ドリフトなし**: 磁界強度から直接位置を算出（積分不要）
- ✅ **遮蔽に強い**: 衣服・体を通過する
- ✅ **セットアップ簡単**: 送信アンテナ1つ置くだけ
- ✅ **低コスト化の余地**: IC数個で構成可能

### EMトラッキングの課題

- ⚠️ 金属環境での歪み（キャリブレーションで対応予定）
- ⚠️ 到達距離に限界（送信出力で調整可能）
- ⚠️ 複数トラッカー時の同期

---

## 動作原理

```
┌─────────────┐          磁界           ┌─────────────┐
│   Beacon    │  ～～～～～～～～～～→  │   Tracker   │
│  （送信）   │                         │  （受信）   │
│             │                         │             │
│ 20kHz交流   │                         │ コイルで    │
│ →コイル駆動 │                         │ 誘導電圧検出│
│ →磁界放射   │                         │ →I/Q処理   │
└─────────────┘                         │ →振幅A算出 │
                                        └─────────────┘
```

### 磁界の性質を利用

1. **磁界強度は距離の3乗に反比例** → 距離が分かる
2. **3軸送受信で方向も分かる** → 姿勢も推定可能
3. **位相も取れる** → 将来的に精度向上

### I/Q同期検波

受信信号を送信周波数と同期したsin/cosで積分し、ノイズを除去しながら振幅Aを算出。

```
A = √(I² + Q²)
```

---

## システム構成（M0）

```
┌──────────────────────────────────────────────────────────┐
│                    XIAO ESP32C3                          │
│  PWM生成（20kHz）              SPI ADC読取 → I/Q処理    │
└──────────┬───────────────────────────────┬───────────────┘
           │                               │
           ▼                               ▼
┌──────────────────┐            ┌──────────────────────────┐
│    DRV8835       │            │       MCP6022            │
│   (Hブリッジ)    │            │    (受信アンプ)          │
└────────┬─────────┘            └────────────┬─────────────┘
         │                                   │
         ▼                                   ▼
┌──────────────────┐            ┌──────────────────────────┐
│   3D11-722J      │   磁界     │       3D11-722J          │
│  (送信コイル)    │ ~~~~~~~~→  │     (受信コイル)         │
└──────────────────┘            └────────────┬─────────────┘
                                             │
                                             ▼
                                ┌──────────────────────────┐
                                │        MCP3008           │
                                │         (ADC)            │
                                └──────────────────────────┘
```

## システム構成（M2）

M2では受信機（Tracker）をバッテリー駆動化し、DEEP SLEEP機能で過放電を防止。

```
┌──────────────────────────────────────────────────────────┐
│                XIAO ESP32C3 (Tracker)                    │
│  バッテリー監視 → DEEP SLEEP      SPI ADC読取 → I/Q処理 │
└──────────┬───────────────────────────────┬───────────────┘
           │                               │
           ▼                               ▼
┌──────────────────┐            ┌──────────────────────────┐
│ Li-Po 3.7V       │            │       MCP6022            │
│ (バッテリー)     │            │    (受信アンプ)          │
└────────┬─────────┘            └────────────┬─────────────┘
         │                                   │
         ▼                                   ▼
┌──────────────────┐            ┌──────────────────────────┐
│ 電圧監視回路     │            │       3D11-722J          │
│ (200kΩ分圧)      │            │     (受信コイル)         │
└────────┬─────────┘            └────────────┬─────────────┘
         │                                   │
         ▼                                   ▼
┌──────────────────┐            ┌──────────────────────────┐
│ Wake-upボタン    │   磁界     │        MCP3008           │
│ (D1ピン)         │ ~~~~~~~~→  │         (ADC)            │
└──────────────────┘            └──────────────────────────┘
```

---

## 使用部品

| 部品 | 型番 | 役割 |
|------|------|------|
| MCU | XIAO ESP32C3 | PWM生成、ADC読取、I/Q処理 |
| 3軸コイル | 3D11-722J (7.2mH) | 送受信アンテナ |
| モータドライバ | DRV8835 | コイル駆動（Hブリッジ） |
| オペアンプ | MCP6022 | 受信信号増幅 |
| ADC | MCP3008 | 波形サンプリング |

---

## ロードマップ

### M0: 1軸PoC（現在）
- [x] 部品調達
- [x] GPIO割り当て
- [x] Vmid生成回路組み立て
- [x] 受信アンプ組み立て・動作確認
- [ ] ADC接続・動作確認
- [ ] 送信回路組み立て
- [ ] PWM生成ファームウェア
- [ ] I/Q処理ファームウェア
- [ ] 共振C最適化
- [ ] 距離・角度応答測定

### M1: 3軸TDM
- 3軸送受信でフル姿勢推定
- Time Division Multiplex（X→Y→Z切替）
- 軸間干渉対策

### M1.5: 自作コイル＆ドライバ強化
- 送信距離拡大のための自作コイル製作
- より高出力のドライバ選定・電源強化
- 3m以上のレンジを目指す

### M2: SMD基板化（バッテリー駆動対応）
- [x] バッテリー駆動仕様策定
- [x] 電圧監視回路設計
- [x] DEEP SLEEP/Wake-up実装
- [ ] 回路図設計（KiCad）
- [ ] 基板レイアウト
- [ ] 実装・動作確認

### M3: 推定アルゴリズム
- 磁界モデルに基づく位置・姿勢推定
- キャリブレーション手法

### M4: 製品化
- 無線化（BLE/ESP-NOW）
- 複数トラッカー同期
- VRChat/SteamVR連携

---

## 参考資料

### EMトラッキングの先行事例
- [Polhemus](https://polhemus.com/) - 医療・研究用EMトラッカー
- [NDI Aurora](https://www.ndigital.com/electromagnetic-tracking/) - 手術ナビゲーション

### 技術資料
- [documents/requirements/m0_poc/specification_v0.9.md](documents/requirements/m0_poc/specification_v0.9.md) - M0詳細仕様書
- [documents/requirements/m2_smd/specification.md](documents/requirements/m2_smd/specification.md) - M2バッテリー駆動仕様書
- [documents/schematics/m2_smd/tracker/power_schematic.md](documents/schematics/m2_smd/tracker/power_schematic.md) - M2電源回路図
- [documents/progress/experiment_log.md](documents/progress/m0_poc/experiment_log.md) - M0実験ログ
- [documents/datasheets/](documents/datasheets/) - 部品データシート

---

## フォルダ構成

```
Loutrack_EM/
├── README.md              # このファイル
├── documents/             # ドキュメント
│   ├── requirements/      # 仕様書（フェーズ別）
│   ├── progress/          # 進捗管理
│   ├── bom/               # 部品リスト
│   ├── schematics/        # 回路図
│   ├── assembly/          # 組み立てガイド
│   └── datasheets/        # データシート
├── firmware/              # ファームウェア
│   ├── lib/               # 共通ライブラリ
│   │   ├── battery_monitor.h/cpp    # バッテリー電圧監視
│   │   └── power_manager.h/cpp      # 電源管理（DEEP SLEEP）
│   └── m2_tracker/         # M2受信機ファームウェア
└── kicad/                 # KiCad設計ファイル
```

---

## ライセンス

TBD

---

## 連絡先

TBD

