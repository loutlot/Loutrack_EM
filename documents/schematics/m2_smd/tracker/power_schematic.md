# M2 Tracker（受信機）電源回路図

## 概要

このドキュメントでは、M2受信機のバッテリー駆動に必要な電源回路を説明します。

---

## 電源系統ブロック図

```
                          ┌─────────────────────────────────────────────────┐
                          │               XIAO ESP32C3                      │
                          │                                                 │
USB-C ════════════════════╪══→ USB ──→ [内蔵充電IC] ──→ BAT+端子           │
                          │                  │            ↓                 │
                          │                  │      ┌─────────┐            │
                          │                  └──────┤ Li-Po   │            │
                          │                         │ 3.7V    │            │
                          │                         └────┬────┘            │
                          │                              │                  │
                          │      ┌───────────────────────┤                  │
                          │      │                       │                  │
                          │      ▼                       ▼                  │
                          │ [トグルSW] ─────────────→ BAT+ ──→ LDO ──→ 3.3V│
                          │                              │                  │
                          │                         [電圧監視]              │
                          │                              │                  │
                          │                              ▼                  │
                          │                         D0 (A0)                 │
                          └─────────────────────────────────────────────────┘
```

---

## 電圧監視回路（詳細）

### 回路図

```
Li-Po BAT+ (3.7V〜4.2V)
     │
     │    ┌────────────────────────────────────────────┐
     │    │                                            │
     ├────┼──[トグルスイッチ]──→ XIAO BAT+端子         │
     │    │                                            │
     │    │   電圧監視回路                             │
     │    │   ┌─────────┐                              │
     └────┼───┤         │                              │
          │   │  200kΩ  │ R1                           │
          │   │         │                              │
          │   └────┬────┘                              │
          │        │                                   │
          │        ├───────────→ D0 (GPIO2/A0)         │
          │        │              XIAO ESP32C3         │
          │   ┌────┴────┐                              │
          │   │         │                              │
          │   │  200kΩ  │ R2                           │
          │   │         │                              │
          │   └────┬────┘                              │
          │        │                                   │
          └────────┴───────────→ GND                   │
                                                       │
                   └───────────────────────────────────┘
```

### 計算

| 項目 | 計算式 | 値 |
|------|--------|-----|
| 分圧比 | R2 / (R1 + R2) | 0.5 (1/2) |
| 消費電流 | V_bat / (R1 + R2) | 4.2V / 400kΩ = 10.5µA (最大) |
| フル充電時 ADC入力 | 4.2V × 0.5 | 2.1V |
| 空時 ADC入力 | 3.0V × 0.5 | 1.5V |

### ADC読み取り値と電圧の対応

| バッテリー電圧 | ADC入力電圧 | 状態 |
|----------------|-------------|------|
| 4.2V | 2.1V | フル充電 |
| 3.7V | 1.85V | 50%程度 |
| 3.3V | 1.65V | 低電圧警告 |
| 3.1V | 1.55V | 過放電閾値 |
| 3.0V | 1.5V | 危険（即シャットダウン） |

---

## Wake-upボタン回路（詳細）

### 回路図

```
        XIAO ESP32C3
             │
             │   D1 (GPIO3)
             │      │
             │      ├───[内部プルアップ 45kΩ]──── 3.3V
             │      │
             │      │
             │      └───[タクトスイッチ]──── GND
             │
             └─────────────────────────────────────
```

### 動作

| ボタン状態 | D1電圧 | ESP32C3状態 |
|------------|--------|-------------|
| 開放（通常） | HIGH (3.3V) | 通常動作 / DEEP SLEEP維持 |
| 押下 | LOW (0V) | Wake-up（DEEP SLEEPから復帰） |

### 設定

```cpp
// 内部プルアップを有効化
pinMode(D1, INPUT_PULLUP);

// Wake-up設定（LOWで起動）
esp_deep_sleep_enable_gpio_wakeup(BIT(D1), ESP_GPIO_WAKEUP_GPIO_LOW);
```

---

## 電源スイッチ接続

### トグルスイッチの配置

```
Li-Po バッテリー
     │
     ├──[+]── トグルスイッチ ───→ XIAO BAT+パッド
     │                              │
     │                         [はんだ付け]
     │                              │
     │                         XIAO ESP32C3
     │                              │
     └──[−]─────────────────────→ GND
```

### XIAO ESP32C3 バッテリー接続パッド

```
        ┌─────────────────────────────────┐
        │         XIAO ESP32C3            │
        │                                 │
USB-C ══╪══                               │
        │                                 │
        │    ┌─────┐    ┌─────┐          │
        │    │ BAT+│    │ BAT-│          │
        │    │ パッド│    │ パッド│          │
        │    └──┬──┘    └──┬──┘          │
        │       │           │             │
        └───────┼───────────┼─────────────┘
                │           │
                ▼           ▼
          [トグルSW]       GND
                │
                ▼
          Li-Po BAT+
```

⚠️ **注意:** XIAOの裏面にあるBAT+/BAT-パッドにはんだ付けが必要です。

---

## 配線表

### 電圧監視回路

| 接続元 | 接続先 | 部品 |
|--------|--------|------|
| Li-Po BAT+ | R1 (200kΩ) 片端 | - |
| R1 (200kΩ) もう片端 | R2 (200kΩ) 片端 | - |
| R1-R2 接続点 | XIAO D0 (GPIO2) | - |
| R2 (200kΩ) もう片端 | GND | - |

### Wake-upボタン

| 接続元 | 接続先 | 部品 |
|--------|--------|------|
| XIAO D1 (GPIO3) | タクトスイッチ 片端 | - |
| タクトスイッチ もう片端 | GND | - |

### 電源スイッチ

| 接続元 | 接続先 | 部品 |
|--------|--------|------|
| Li-Po BAT+ | トグルスイッチ COM | JST-PHコネクタ |
| トグルスイッチ NO | XIAO BAT+パッド | はんだ付け |
| Li-Po BAT- | XIAO GND | JST-PHコネクタ |

---

## 部品リスト

| 部品 | 仕様 | 数量 | 秋月コード | 備考 |
|------|------|------|-----------|------|
| 抵抗 | 200kΩ 1/4W 1% | 2 | - | 電圧分圧用 |
| トグルスイッチ | SPST | 1 | - | メイン電源 |
| タクトスイッチ | 6mm角 | 1 | 103647 | Wake-up用 |
| JST-PHコネクタ | 2ピン メス | 1 | - | バッテリー接続 |
| Li-Poバッテリー | 3.7V 500mAh以上 | 1 | - | 電源 |

---

## 安全上の注意

⚠️ **バッテリー取り扱い注意:**

1. **ショート厳禁:** BAT+とGNDを絶対にショートさせないこと
2. **極性確認:** バッテリーの+/-を必ず確認してから接続
3. **はんだ作業:** XIAOのBAT+パッドへのはんだ付けは慎重に（隣接パッドとのブリッジに注意）
4. **過放電防止:** 3.0V以下まで放電させないこと（ファームウェアで保護）
5. **保管:** 使用しない場合はトグルスイッチをOFFにして保管

---

## 変更履歴

| 日付 | 内容 | 変更者 |
|------|------|--------|
| 2026-01-11 | 初版作成 | - |
