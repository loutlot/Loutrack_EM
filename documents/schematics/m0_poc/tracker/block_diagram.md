# M0 Tracker（受信）ブロック図

## 回路ブロック図

```
┌─────────────────────────────────────────────────────────────────────┐
│                       受信コイル                                     │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │    端子A ────[  L (コイル)  ]──── 端子B                     │    │
│  │       │                            │                       │    │
│  │       └─→ Vmidへ接続               └─→ アンプ入力へ        │    │
│  │                                                            │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Vmid生成（仮想GND）                              │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │   3.3V ──[10kΩ]──┬──[10kΩ]── GND                          │    │
│  │                   │                                        │    │
│  │                   ├── 0.1µF ── GND (平滑)                  │    │
│  │                   │                                        │    │
│  │                   └──→ MCP6022 電圧フォロワ入力            │    │
│  │                              │                             │    │
│  │                              └──→ Vmid (バッファ後)        │    │
│  │                                   = 1.65V (安定)           │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│              MCP6022 受信アンプ（非反転増幅）                        │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │   【Vmidバッファ（1ch目）】                                │    │
│  │   Vmid_raw ──[+]──┬── Vmid_out                            │    │
│  │              [-]──┘                                        │    │
│  │                                                            │    │
│  │   【受信アンプ（2ch目）】                                  │    │
│  │                     ┌─[47pF]─┐                            │    │
│  │                     │        │                            │    │
│  │   コイル信号 ──[+]──┤        ├── ADC入力へ                │    │
│  │              [-]──┬─[10kΩ Rf]┘                            │    │
│  │                   │                                        │    │
│  │                [1kΩ Rg]                                    │    │
│  │                   │                                        │    │
│  │                 Vmid                                       │    │
│  │                                                            │    │
│  │   Gain = 1 + Rf/Rg = 1 + 10k/1k = 11倍                    │    │
│  │                                                            │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  電源デカップリング:                                                │
│  └─ 0.1µF (VDD-GND) ← IC近傍                                       │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  入力保護（BAT43クランプ）                           │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │   3.3V ──|◁── ADC入力 ──▷|── GND                          │    │
│  │       (BAT43)          (BAT43)                             │    │
│  │                                                            │    │
│  │   ※ 過大入力時に3.3VまたはGNDへクランプ                   │    │
│  │   ※ 実験中の誤配線対策                                    │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      MCP3008（ADC）                                  │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │   VDD = 3.3V ──┬── 0.1µF ── GND                           │    │
│  │   VREF = 3.3V ──┬── 0.1µF ── AGND                         │    │
│  │                                                            │    │
│  │   CH0 ←── 受信アンプ出力                                  │    │
│  │   CH1〜CH7: 未使用（将来3軸用）                            │    │
│  │                                                            │    │
│  │   SPI:                                                     │    │
│  │   ├─ CLK  ──→ ESP32 GPIO_TBD                              │    │
│  │   ├─ DOUT ──→ ESP32 GPIO_TBD (MISO)                       │    │
│  │   ├─ DIN  ←── ESP32 GPIO_TBD (MOSI)                       │    │
│  │   └─ CS   ←── ESP32 GPIO_TBD                              │    │
│  │                                                            │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         ESP32-S3                                    │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │   SPI受信 → I/Q処理                                        │    │
│  │   ├─ cos/sin参照波と乗算                                   │    │
│  │   ├─ 積分窓長で積分                                        │    │
│  │   └─ A = √(I²+Q²), φ = atan2(Q,I)                         │    │
│  │                                                            │    │
│  │   出力: 振幅A（主要評価値）                                │    │
│  │                                                            │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

## アンプゲイン調整

| 状態 | 対策 |
|------|------|
| ADCが飽和（0または3.3Vに張り付く） | Rfを小さく（例: 5.1kΩでGain≈6） |
| 信号が小さすぎる | Rfを大きく（例: 22kΩでGain≈23） |
| 発振する | 47pFを追加、または大きく |

## ADCサンプルレート設定

MCP3008の理論最大: 200ksps @ 5V, 75ksps @ 2.7V

**PoC目標:** ≥80ksps

ESP32側のSPIクロック設定で調整

