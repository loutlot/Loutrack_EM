# M0 Beacon（送信）ブロック図

## 回路ブロック図

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ESP32-S3                                    │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  LEDC / PWM Generator                                         │  │
│  │  ├─ 20kHz, 50% duty                                          │  │
│  │  └─ 将来: TDMスロット制御                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│           │ PWM                    │ PWM_INV (反転)                 │
│           │ GPIO_TBD               │ GPIO_TBD                       │
└───────────┼────────────────────────┼────────────────────────────────┘
            │                        │
            ▼                        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      DRV8835 モジュール                              │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  VCC ←── 5V (USB)                                          │    │
│  │  GND ←── GND                                               │    │
│  │  VIN ←── 3.3V (ロジック電圧)                                │    │
│  │  MODE ←── Hi (IN/IN モード)                                │    │
│  │                                                            │    │
│  │  AIN1 ←── PWM                                              │    │
│  │  AIN2 ←── PWM_INV (または GND固定)                         │    │
│  │                                                            │    │
│  │  AOUT1 ──┬──→ 送信コイル端子A                              │    │
│  │  AOUT2 ──┴──→ 送信コイル端子B                              │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  デカップリング:                                                    │
│  ├─ 0.1µF (5V-GND) ← VCC近傍                                       │
│  └─ 100µF電解 (5V-GND) ← 電源バルク                                │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     送信コイル + 共振C                               │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │    AOUT1 ────┬────[  L (コイル)  ]────┬──── AOUT2          │    │
│  │              │                        │                    │    │
│  │              └────[  C (共振C)   ]────┘                    │    │
│  │                                                            │    │
│  │  ※ L-C並列で20kHz付近に共振点を合わせる                    │    │
│  │  ※ Cは実測で最適値を探索                                   │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
        【磁界放射】
```

## DRV8835 駆動モードの選択

### 推奨: IN/IN モード（MODE = Hi）

| AIN1 | AIN2 | AOUT1 | AOUT2 | 動作 |
|------|------|-------|-------|------|
| Hi | Lo | Hi | Lo | 正方向 |
| Lo | Hi | Lo | Hi | 逆方向 |
| Hi | Hi | Hi | Hi | ブレーキ |
| Lo | Lo | Lo | Lo | コースト |

### ±駆動（推奨）

```
AIN1 = PWM (20kHz, 50%)
AIN2 = PWM反転 (20kHz, 50%, 位相180°)

→ コイルに交互に±電圧が印加され、磁界強度が最大化
```

### 片側駆動（簡易版）

```
AIN1 = PWM (20kHz, 50%)
AIN2 = Lo 固定

→ 配線は簡単だが、磁界強度は±駆動の半分程度
```

## 共振Cの選定

共振周波数: f = 1 / (2π√(LC))

20kHz共振の場合:
- L = 7.7mH → C ≈ 8200pF
- L = 6.5mH → C ≈ 9700pF

**実測手順:**
1. まず共振Cなしで送信
2. 8200pF → 8760pF → 9700pF の順で試す
3. 受信側のI/Q振幅Aが最大になるCを採用


