# EMトラッキング PoC 仕様書

## ディスクリート→3軸TDM→SMD基板化ロードマップ

**Version:** 0.9  
**作成日:** 2026-01-07  
**対象:** 磁界（EM）ベースのドリフトレス計測 PoC（1軸→3軸TDMへ拡張可能な構造）

---

## 1. 目的とゴール

### 1.1 目的

- EM（磁界）だけで「積分ドリフトなし」の計測が成立するかを検証する
- 送信（Beacon）→受信（Tracker）→I/Q（同期検波） の最小パイプラインをPoCで成立させる
- 将来仕様（3軸TDM＋I/Q＋受信アンプ＋SMD基板）へ、配線・ソフト・データ構造を流用可能な形で実装する

### 1.2 PoCの達成条件（Acceptance Criteria）

PoC（1軸）で以下を満たすこと：

| # | 条件 |
|---|------|
| 1 | 送信ON時、受信信号からI/Qで **安定した振幅A** が算出できる |
| 2 | 送受コイルの距離・角度を変えると、Aが再現性のある単調変化を示す |
| 3 | 送信OFF時は、Aが十分小さく（ノイズフロア）、ON/OFFが明確に判別できる |
| 4 | 1フレーム（例: 16.7ms）内に I/Q 算出が完了し、60Hz相当の更新が可能 |

---

## 2. スコープ

### 2.1 PoC段階のスコープ

- **送信:** 20kHz帯の矩形波をHブリッジでコイル駆動し、L＋共振Cで正弦寄りの磁界を生成
- **受信:** コイル → MCP6022増幅（Vmid基準） → MCP3008 ADC → ESP32S3でI/Q演算
- **段階:**
  1. 1軸送受で成立
  2. 次に **3軸TDM（X→Y→Z時間切替）** へ拡張（同一構造の増殖）

### 2.2 非スコープ（PoCで未実装でもOK）

- VRワールド座標への整列（HMDアンカーによる剛体変換）
- 多トラッカー運用時の無線最適化（帯域、混信、低遅延化）
- 金属環境補正の高度化（環境モデル・キャリブレーション高度化）

---

## 3. 用語と前提

| 用語 | 説明 |
|------|------|
| **Beacon（送信）** | コイルへ交番電流を流し、磁界を作る側 |
| **Tracker（受信）** | コイルで誘導電圧を受け、I/Q処理する側 |
| **Vmid** | 単電源アナログ処理用の仮想GND（3.3V系では1.65V） |
| **I/Q（同期検波）** | 受信波形v(t)をcos/sin参照波で積分し、振幅と位相を得る手法 |
| **TDM** | Time Division Multiplex: X/Y/Z軸送信を時間枠で切り替え識別する方式 |

---

## 4. システム全体アーキテクチャ

### 4.1 ブロック図（論理）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Beacon（送信）                                │
├─────────────────────────────────────────────────────────────────┤
│  ESP32S3                                                        │
│  ├─ 20kHzキャリア生成（PWM/LEDC等）                              │
│  └─ TDMスロット制御（将来3軸）                                   │
│           ↓                                                     │
│  DRV8835（Hブリッジ）                                            │
│  └─ コイルへ±電圧印加（交番電流生成）                            │
│           ↓                                                     │
│  コイル（PoC）＋ 共振C                                           │
│  └─ 高調波を抑えて「正弦寄りの電流波形」にする                   │
└─────────────────────────────────────────────────────────────────┘
           ↓ 磁界
┌─────────────────────────────────────────────────────────────────┐
│                    Tracker（受信）                               │
├─────────────────────────────────────────────────────────────────┤
│  コイル（PoC）                                                   │
│  └─ 20kHz近傍の誘導電圧を発生                                    │
│           ↓                                                     │
│  MCP6022（オペアンプ）                                           │
│  └─ Vmid基準で増幅（単電源で交流を扱う）                         │
│           ↓                                                     │
│  MCP3008（ADC 8ch）                                              │
│  └─ 生波形をサンプルしESP32へSPI転送                             │
│           ↓                                                     │
│  ESP32S3                                                         │
│  └─ I/Q（同期検波）→ A/φ算出                                    │
│     （将来）軸ごとの観測ベクトルから姿勢/位置推定へ拡張          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. PoC仕様（ディスクリート実装）

### 5.1 電気仕様（PoCターゲット）

| 項目 | 値 |
|------|-----|
| 送信周波数 | 20kHz（±数%は許容、I/Q参照で追従） |
| 更新レート | 60Hz相当以上（内部はスロット制御でI/Q積分） |
| 受信ADC目標サンプルレート | ≥ 80ksps（20kHzに対して4サンプル/周期以上） |
| アナログ電源 | 3.3V単一（Vmid=1.65V） |
| 送信電源 | USB 5V想定（PoC） |

---

## 6. 回路仕様（PoC：1軸）

### 6.1 Beacon（送信）回路仕様

#### 6.1.1 コイル駆動

- DRV8835の1chで1軸コイルを駆動
- **駆動方式（PoC推奨順）:**
  1. AIN1 = PWM / AIN2 = 反転PWM（±駆動で磁界強度が取りやすい）
  2. AIN1 = PWM / AIN2 = Low固定（簡単だが磁界が弱くなる場合あり）

#### 6.1.2 共振C（"矩形波を丸める"）

- コイル両端にCを並列接続し、L-Cで共振点を20kHz近傍へ寄せる
- PoCでは理論一致より **受信振幅が最大となるCを実測で探索する**
- **手持ちCセットの使い方:**
  - 8200pF
  - 8200+560=8760pF
  - 8200+1500=9700pF
  - 6800pF、6800+1500…
  - の順で試し、受信I/Q振幅が最大になる点を採用

#### 6.1.3 電源デカップリング

- DRV8835近傍に:
  - 0.1µF（5V-GND）
  - 電解100µF（5V-GND）
- 送信系GNDは受信系GNDと一点接続（ノイズ回り込み防止）

### 6.2 Tracker（受信）回路仕様

#### 6.2.1 Vmid生成（仮想GND）

- 10k/10k分圧で1.65V生成（Vmid_raw）
- Vmid_rawを0.1µFで平滑、可能なら電解も追加
- MCP6022の1chを電圧フォロワとしてVmidをバッファ（推奨）
- 以後すべてのアナログ基準はVmid

#### 6.2.2 受信アンプ（1軸・非反転、Vmid基準）

- 受信コイル片端をVmidへ固定し、もう一端を信号入力とする（単端化）
- 入力はVmidにバイアスされるよう構成（ACカップリング or 直結＋抵抗で調整）
- **非反転アンプ:**
  - Gain = 1 + Rf/Rg = 11（Rf=10k, Rg=1k、Rg下端はVmid）
  - 発振時の対策: 47pFをRfに並列（高域ゲインを落とす）
- **目標:** ADCレンジ（0–3.3V）に収まること
  - 飽和する場合はゲインを下げる（または入力を下げる）
  - 弱い場合は2段増幅（将来3軸化時はchが逼迫するのでPoCのみ推奨）

#### 6.2.3 入力保護（BAT43）

- ADC入力を3.3V/GNDへクランプするショットキーを実装（保険）
- 実際には誘導電圧は小さい想定だが、実験時の誤配線対策

#### 6.2.4 ADC（MCP3008）

- VDD=3.3V、VREF=3.3V
- **デカップリング:**
  - VDD-GNDに0.1µF
  - VREF-AGNDに0.1µF
- CH0に受信アンプ出力を入力（PoC）

---

## 7. ファームウェア仕様（PoC：1軸→3軸へ流用）

### 7.1 送信（Beacon側）

- 20kHz PWM生成
- 将来のTDMに備え、スロット制御ステートマシンを最初から実装
- PoCはスロットXのみ有効で動作
- スロット切替は将来X→Y→Zへ拡張

### 7.2 受信（Tracker側）

- MCP3008から波形サンプルを取得
- **I/Q処理:**
  - 参照波cos/sinはNCOまたはテーブル
  - 積分窓長はパラメータ化（0.5ms〜5ms程度で探索）
- **出力:**
  - 振幅 A = sqrt(I²+Q²)
  - 位相 φ = atan2(Q, I)
- PoCではAを主要評価値とする（位相は観測の健全性チェック用途）

### 7.3 TDM（3軸化時）

- フレームを3スロットに分割し、送信軸を切り替える
- 各スロットで独立にI/Q積分し、(Ax, Ay, Az)を得る
- スロット間の過渡（コイルの立上り/共振の安定）を見込んだ "待ち時間（settling）"をパラメータ化（例: 0.2〜1.0ms）

---

## 8. 検証計画（PoCの進め方）

### 8.1 立ち上げ手順（最短）

| Step | 内容 | 確認項目 |
|------|------|----------|
| 1 | 受信系単体 | ADCがVmid付近を中心に安定していること |
| 2 | 送信系単体 | DRV8835が過熱しない、電源が落ちない |
| 3 | 送受近接（数cm） | Aが明確に上がること、距離を離すと下がること |
| 4 | 共振C探索 | Cを変え、Aが最大の点を採用 |
| 5 | 距離・角度スイープ | Aの再現性（同じ配置に戻すと同程度のA） |

### 8.2 成功判定に必要なログ

- サンプルレート、積分窓長、A（平均/分散）、送信スロット状態
- 送信PWM設定値、電源電圧（可能なら）

---

## 9. リスクと対策（PoC段階）

| リスク | 対策 |
|--------|------|
| ノイズ（送信スイッチングの回り込み） | 送受を物理分離、GND一点接続、ADC/OPAMP近傍デカップリング |
| 信号が弱い | 共振C最適化、コイルの向き・距離見直し、積分窓長増、（PoCのみ）2段増幅 |
| DRV8835の送信出力不足（距離を稼げない） | PoCの目的は"パイプライン成立"なので、まず近距離で成立を優先。将来は送信ドライバ/電源の増強をロードマップに含める |

---

## 10. 3軸TDMへの拡張仕様（次フェーズ）

### 10.1 ハード拡張

- **送信:**
  - DRV8835 2枚で3軸駆動（合計4chのうち3ch使用）
  - コイルは3軸（3Dコイル or 立方体巻線）を用意
- **受信:**
  - MCP6022を「Vmidバッファ1ch＋増幅3ch」で使用
  - MCP3008 CH0-CH2へ各軸アンプ出力を入力

### 10.2 ソフト拡張

- スロット制御: X→Y→Z
- 各スロットでI/Q積分して (Ax, Ay, Az) を算出
- PoCの次の評価:
  - 軸間干渉（他軸送信時の漏れ）
  - スロット切替時の過渡（settling time）

---

## 11. SMD基板化（量産に向けた設計方針）

### 11.1 目的

- 配線の寄生成分とノイズ混入を減らし、再現性を上げる
- 3軸＋受信＋ADCの構成を一体化し、調整点を減らす

### 11.2 基板分割（推奨）

- **Beacon基板（送信）とTracker基板（受信）** は分ける
- 送信のスイッチングノイズを受信から隔離
- 受信基板は「アナログ（コイル/AMP）」「デジタル（ADC/MCU/無線）」をレイアウトで分離

### 11.3 回路のSMD化での重要ポイント

- Vmidは必ずバッファ（低インピーダンス）で全体へ配布
- ADCのVREF周りは最優先で静かに（スターGND、短配線、デカップリング密）
- コイル入力は保護・ESD・クランプを入れつつ、過剰な容量を増やさない
- 送信側Hブリッジは熱と電源バルク配置を最優先

### 11.4 将来の部品置換（PoC→製品）

| PoC部品 | 置換候補 |
|---------|----------|
| MCP3008（SPI ADC） | サンプルレート/分解能/同期性の良いADC |
| DRV8835 | 送信電流を上げられるドライバ（レンジ3m目標時） |
| コイル | 3Dコイル（市販）or 立方体巻線（50mm立方体、線径・巻数最適化） |

---

## 12. ロードマップ（推奨マイルストーン）

| マイルストーン | 内容 |
|----------------|------|
| **M0** | 1軸ディスクリートPoC成立: Aの安定算出、C最適化、距離/角度応答の確認 |
| **M1** | 3軸TDM（ディスクリート）: (Ax,Ay,Az)がスロットで正しく分離できる、軸干渉・過渡対策のパラメータ確立 |
| **M2** | 3軸SMD試作基板（機能同等）: ディスクリートPoCと同等のA応答を再現、ノイズ・再現性の改善 |
| **M3** | 推定アルゴリズム拡張: 3軸観測ベクトルを用いた姿勢/位置推定の初期実装（環境誤差は未補正で可） |
| **M4** | 製品化要素: 送信出力拡張（レンジ）、無線多端末（同期、帯域）、HMDアンカー整列（ワールド座標） |

---

## 付録

### 付録A: 現在BOM（秋月購入分）

→ `documents/bom/` フォルダ参照

### 付録B: PoCでの「最小配線規約」（再現性のためのルール）

1. 送信系と受信系はブレッドボードで距離を取る
2. GNDは一点接続（受信側で合流）
3. Vmidは必ずバッファして配布
4. ADC VREFは最優先でデカップリング
5. コイル入力配線は最短（可能ならツイスト）

