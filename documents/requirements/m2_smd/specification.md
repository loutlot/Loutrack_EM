# M2: 3軸SMD試作基板 仕様書

**Version:** 1.0  
**作成日:** 2026-01-11  
**対象:** 3軸TDM + バッテリー駆動対応の受信機SMD基板

---

## 1. 概要

M2フェーズでは、M1で確立した3軸TDMシステムをSMD基板化し、受信機にバッテリー駆動機能を追加します。

### 1.1 目標

- ディスクリートPoCと同等のA応答を再現
- ノイズ・再現性の改善
- 受信機のバッテリー駆動対応

### 1.2 構成

| ユニット | 電源 | MCU | 備考 |
|----------|------|-----|------|
| 送信機（Beacon） | USB 5V | XIAO ESP32C3 | 固定設置 |
| 受信機（Tracker） | Li-Po 3.7V | XIAO ESP32C3 | バッテリー駆動 |

---

## 2. 受信機 GPIO割り当て

### 2.1 ピンマップ

| ピン | GPIO | 機能 | 備考 |
|------|------|------|------|
| D0 | GPIO2 | **バッテリー電圧監視 (A0)** | 200kΩ分圧で接続 |
| D1 | GPIO3 | **Wake-upボタン** | LOW→Wake-up、内部プルアップ使用 |
| D2 | GPIO4 | 予備 | |
| D3 | GPIO5 | 予備 | |
| D4 | GPIO6 | 予備 | |
| D5 | GPIO7 | 予備 | |
| D6 | GPIO21 | 予備 | |
| D7 | GPIO20 | SPI_CS (MCP3008) | |
| D8 | GPIO8 | SPI_SCK | |
| D9 | GPIO9 | SPI_MISO | |
| D10 | GPIO10 | SPI_MOSI | |

**使用: 6ピン / 予備: 5ピン**

### 2.2 制約事項

- **Wake-up対応ピン:** ESP32C3ではD0〜D3 (GPIO2, 3, 4, 5) のみ対応
- **ADC1対応ピン:** D0〜D2 (GPIO2, 4, 3) はADC1を使用、WiFi動作時も利用可能
- **ADC2対応ピン:** D3 (GPIO5) はADC2を使用、WiFi動作時は利用不可

---

## 3. 送信機 GPIO割り当て

### 3.1 ピンマップ

| ピン | GPIO | 機能 | 備考 |
|------|------|------|------|
| D0 | GPIO2 | PWM_X | X軸送信PWM |
| D1 | GPIO3 | PWM_X_INV | X軸反転PWM（またはGND固定） |
| D2 | GPIO4 | PWM_Y | Y軸送信PWM |
| D3 | GPIO5 | PWM_Y_INV | Y軸反転PWM（またはGND固定） |
| D4 | GPIO6 | PWM_Z | Z軸送信PWM |
| D5 | GPIO7 | PWM_Z_INV | Z軸反転PWM（またはGND固定） |
| D6 | GPIO21 | 予備 | |
| D7 | GPIO20 | 予備 | |
| D8 | GPIO8 | 予備 | |
| D9 | GPIO9 | 予備 | |
| D10 | GPIO10 | 予備 | |

**使用: 6ピン / 予備: 5ピン**

---

## 4. バッテリー駆動仕様（受信機のみ）

### 4.1 電源仕様

| 項目 | 仕様 |
|------|------|
| バッテリー種別 | Li-Po 3.7V (1セル) |
| 充電方式 | USB-C経由、XIAO内蔵充電回路使用 |
| 過充電防止 | XIAO内蔵回路で対応 |
| 過放電防止 | ソフトウェア監視 + DEEP SLEEP |

### 4.2 電圧監視

| 項目 | 値 |
|------|-----|
| 監視ピン | D0 (GPIO2 / A0) |
| 分圧抵抗 | 200kΩ × 2（1/2分圧） |
| フル充電電圧 | 4.2V（ADC読み値: 2.1V） |
| 低電圧警告 | 3.3V（ADC読み値: 1.65V） |
| 過放電閾値 | 3.1V（ADC読み値: 1.55V） |

### 4.3 電源スイッチ

| スイッチ | 種類 | 機能 |
|----------|------|------|
| メインスイッチ | トグル | バッテリーとXIAO間を物理的に切断 |
| Wake-upボタン | モーメンタリ | DEEP SLEEPからの復帰 |

### 4.4 DEEP SLEEP仕様

| 項目 | 仕様 |
|------|------|
| Wake-upピン | D1 (GPIO3) |
| Wake-up条件 | LOW（ボタン押下時） |
| 内部プルアップ | 有効 |
| DEEP SLEEP消費電流 | 約5µA（XIAO ESP32C3仕様） |

---

## 5. 回路仕様

### 5.1 電圧監視回路

```
BAT+ ──[200kΩ]──┬──[200kΩ]── GND
                │
                └── D0 (A0/GPIO2)
```

### 5.2 Wake-upボタン回路

```
D1 (GPIO3) ──┬── [内部プルアップ]
             │
             └── [モーメンタリSW] ── GND
```

---

## 6. ファームウェア仕様

### 6.1 バッテリー電圧監視

- 監視間隔: 1秒ごと
- 平均化: 16回サンプリングの平均
- `analogReadMilliVolts()` を使用（チップ個体差補正済み）

### 6.2 過放電防止フロー

```
起動
  ↓
電圧監視（1秒間隔）
  ↓
┌─ V < 3.1V → 即座にDEEP SLEEP
├─ V < 3.3V → 警告状態（一定時間後にDEEP SLEEP）
└─ V ≥ 3.3V → 通常動作
```

### 6.3 Wake-up処理

1. ボタン押下でDEEP SLEEPから復帰
2. 起動時に電圧チェック
3. 電圧が十分（≥3.3V）なら通常動作開始
4. 電圧が不足なら再度DEEP SLEEP

---

## 7. 必要部品（バッテリー関連追加分）

| 部品 | 仕様 | 数量 | 用途 |
|------|------|------|------|
| 抵抗 200kΩ | 1/4W, 1% | 2 | 電圧分圧 |
| トグルスイッチ | SPST | 1 | メイン電源ON/OFF |
| タクトスイッチ | モーメンタリ | 1 | Wake-up用 |
| Li-Poバッテリー | 3.7V, 500mAh以上 | 1 | 電源 |
| JST-PHコネクタ | 2ピン | 1 | バッテリー接続 |

---

## 8. 注意事項

1. **XIAO内蔵充電回路を使用**: 外部充電IC（TP4056等）は不要
2. **トグルスイッチの配置**: バッテリーのプラス側に挿入
3. **Wake-up対応ピン制限**: ESP32C3ではD0〜D3のみ対応
4. **ADC精度**: チップ個体差があるため、キャリブレーション推奨
5. **通信時のノイズ**: WiFi通信時はADC読み取りにスパイクが発生するため、16回平均化を実施

---

## 変更履歴

| 日付 | 内容 | 変更者 |
|------|------|--------|
| 2026-01-11 | 初版作成（バッテリー駆動仕様追加） | - |
