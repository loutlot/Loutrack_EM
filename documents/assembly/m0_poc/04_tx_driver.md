# モジュール4: 送信ドライバ（DRV8835）

## 概要

このモジュールでは:
1. DRV8835モジュールをブレッドボードに配置
2. XIAO ESP32C3からのPWM信号で駆動
3. 送信コイル（3D11-722J）と共振コンデンサを接続

---

## DRV8835モジュールについて

DRV8835は**デュアルHブリッジモータドライバ**です。
通常はモーター制御に使いますが、ここでは**交流電流を生成してコイルを駆動**します。

### 秋月モジュール（109848）のピン配置

```
┌─────────────────────────────┐
│  DRV8835モジュール (109848) │
│                             │
│  VM  ─ モータ電源（5V）     │
│  VCC ─ ロジック電源（3.3V） │
│  GND ─ グランド             │
│                             │
│  AIN1 ─ A側入力1            │
│  AIN2 ─ A側入力2            │
│  AOUT1 ─ A側出力1           │
│  AOUT2 ─ A側出力2           │
│                             │
│  BIN1 ─ B側入力1            │
│  BIN2 ─ B側入力2            │
│  BOUT1 ─ B側出力1           │
│  BOUT2 ─ B側出力2           │
│                             │
│  MODE ─ モード選択          │
└─────────────────────────────┘
```

⚠️ **注意:** モジュールの実際のシルク印刷を確認してください。

---

## 3D11-722Jコイルについて

AliExpressで入手した3軸コイル:
- 型番: 3D11-722J
- 構造: 3軸直交コイル内蔵
- インダクタンス: 各軸約7.2mH（722 = 72 × 10² = 7200µH = 7.2mH）
- リンク: [AliExpress](https://ja.aliexpress.com/item/1005004723068527.html)

**M0では1軸のみ使用します。**

---

## 必要な部品

| 部品 | 秋月コード | 数量 | 用途 |
|------|------------|------|------|
| DRV8835モジュール | 109848 | 1 | Hブリッジ |
| コンデンサ 0.1µF | 117059 | 1 | 電源デカップリング |
| 電解コンデンサ 100µF | 105002 | 1 | バルクデカップリング |
| 3D11-722J | - | 1 | 送信コイル（1軸使用） |
| 共振コンデンサ | 108125等 | 1セット | 波形整形 |

---

## 手順

### Step 1: モジュールの配置

⚠️ **重要:** DRV8835は**受信回路から離して配置**してください（5cm以上推奨）。

送信系のスイッチングノイズが受信系に影響するのを防ぎます。

```
ブレッドボード配置例:

[受信側エリア]              [送信側エリア]
MCP6022, MCP3008           DRV8835, コイル
     ↑                          ↑
     └─────── 5cm以上 ──────────┘
```

### Step 2: 電源接続

| ピン | 接続先 | 備考 |
|------|--------|------|
| VM | 5Vレール | モータ電源（送信電力） |
| VCC | 3.3Vレール | ロジック電圧（XIAO ESP32C3に合わせる） |
| GND | GNDレール | |
| MODE | 3.3Vレール | Hiで IN/IN モード |

### Step 3: デカップリングコンデンサ

**VM近傍に:**

1. 0.1µF: VM-GND間
2. 100µF電解: VM-GND間

⚠️ **電解コンデンサの極性に注意!** 長い足が+（プラス）側です。

### Step 4: XIAO ESP32C3からPWM信号接続

**±駆動モード（推奨）:**

| DRV8835ピン | XIAOピン | GPIO | 説明 |
|-------------|----------|------|------|
| AIN1 | D0 | GPIO2 | 20kHz PWM |
| AIN2 | D1 | GPIO3 | 反転PWM |

**片側駆動モード（簡易）:**

| DRV8835ピン | 接続先 | 説明 |
|-------------|--------|------|
| AIN1 | XIAO D0 (GPIO2) | 20kHz PWM |
| AIN2 | GND | 固定Low |

💡 **最初は片側駆動で試して**、動作確認後に±駆動に変更するのが安全です。

### Step 5: コイル接続（3D11-722J）

3D11-722Jは3軸コイルですが、M0では**1軸のみ**使用します。

```
3D11-722J ピン配置（例）:
┌─────────────────┐
│                 │
│  X+ ─┬─ X軸    │
│  X- ─┘         │
│                 │
│  Y+ ─┬─ Y軸    │  ← M1で使用
│  Y- ─┘         │
│                 │
│  Z+ ─┬─ Z軸    │  ← M1で使用
│  Z- ─┘         │
│                 │
└─────────────────┘
```

**M0での接続:**

| DRV8835ピン | 接続先 |
|-------------|--------|
| AOUT1 | 3D11-722J X+ |
| AOUT2 | 3D11-722J X- |

⚠️ コイルのピン配置は実物を確認してください。

### Step 6: 共振コンデンサ

コイルと**並列**に共振Cを接続:

```
AOUT1 ──┬────[コイル L]────┬── AOUT2
        │                  │
        └────[共振C]───────┘
```

**3D11-722J（L ≈ 7.2mH）の場合:**

20kHz共振に必要なC:
```
f = 1 / (2π√(LC))
C = 1 / (4π²f²L)
C = 1 / (4 × 3.14² × 20000² × 0.0072)
C ≈ 8800pF
```

**最初は8200pF + 560pF = 8760pFから試してください。**

---

## XIAO ESP32C3 PWM生成コード

```cpp
// XIAO ESP32C3 PWM生成
#include <Arduino.h>

const int PWM_PIN = 2;       // D0 = GPIO2
const int PWM_INV_PIN = 3;   // D1 = GPIO3（±駆動時）
const int PWM_FREQ = 20000;  // 20kHz
const int PWM_RESOLUTION = 8; // 8bit (0-255)

// LEDC チャンネル
const int PWM_CHANNEL = 0;
const int PWM_INV_CHANNEL = 1;

void setup() {
  Serial.begin(115200);
  
  // PWMチャンネル0設定
  ledcSetup(PWM_CHANNEL, PWM_FREQ, PWM_RESOLUTION);
  ledcAttachPin(PWM_PIN, PWM_CHANNEL);
  ledcWrite(PWM_CHANNEL, 128);  // 50% duty
  
  // ±駆動の場合（簡易版: 同じPWMを両方に出力）
  // 完全な反転は追加のハード or ソフト対応が必要
  // まずは片側駆動（AIN2=GND）で試すことを推奨
  
  Serial.println("PWM Started: 20kHz, 50% duty");
}

void loop() {
  // 送信は常時ON（PoCでは）
  delay(1000);
  Serial.println("TX running...");
}
```

---

## 動作確認

### 確認前のチェック

- [ ] VMが5Vに接続されている
- [ ] VCCが3.3Vに接続されている
- [ ] GNDが接続されている
- [ ] MODEが3.3V（Hi）に接続されている

### 電源投入時の確認

| 確認項目 | 正常 | 異常時の対策 |
|----------|------|--------------|
| DRV8835の発熱 | 常温〜微温 | 熱い場合は即電源OFF、配線確認 |
| XIAO ESP32C3の動作 | 正常起動（LED点灯） | リセット、電源確認 |

### オシロスコープがある場合

1. AOUT1-AOUT2間の波形を確認
2. 20kHzの矩形波（または共振で丸まった波形）が観測されればOK

### オシロがない場合

受信側で確認:
1. 送信コイル（3D11-722J X軸）と受信コイルを5cm程度に近づける
2. ADCの値がVmid（512）から大きく振れればOK

---

## 共振C探索の手順

3D11-722J (L ≈ 7.2mH) の場合:

| C値 | 共振周波数（理論） | A（実測） |
|-----|-------------------|-----------|
| なし | - | __ |
| 8200pF | 20.6kHz | __ |
| 8200+560pF = 8760pF | 20.0kHz | __ |
| 8200+1500pF = 9700pF | 19.0kHz | __ |
| 6800pF | 22.9kHz | __ |

**Aが最大になったC値を採用**

---

## トラブルシューティング

| 症状 | 原因 | 対策 |
|------|------|------|
| DRV8835が熱くなる | 出力ショート、過電流 | 即電源OFF、配線確認 |
| 波形が出ない | PWMが出力されていない | GPIO確認、コード確認 |
| 受信側で信号が見えない | コイルが離れすぎ、共振ズレ | コイルを近づける、C値を変える |

---

## 回路図まとめ

```
                 5V
                  │
               [100µF]
                  │
                  ├──[0.1µF]── GND
                  │
          ┌───────┴───────┐
          │    DRV8835    │
          │    (109848)   │
          │               │
3.3V ────→│VCC       VM  │←── 5V
          │               │
3.3V ────→│MODE    AOUT1│──┬──[3D11-722J X軸]──┬── AOUT2
          │               │  │                   │
XIAO D0 ─→│AIN1    AOUT2│──│───────────────────┘
          │               │  │
GND ─────→│AIN2          │  └──[共振C 8760pF]───┘
          │               │
          │         GND  │←── GND
          └───────────────┘
```

---

## 次のステップ

✅ 送信回路の動作確認が完了したら、[05_integration.md](05_integration.md) へ進みます。

