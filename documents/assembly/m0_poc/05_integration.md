# モジュール5: 全体結合と動作確認

## 概要

このモジュールでは:
1. 送信系と受信系を結合
2. 受信コイル（3D11-722J）を接続
3. I/Q処理で振幅Aを算出
4. 距離・角度応答を確認

---

## 3D11-722Jの送受信配置

3D11-722Jは3軸コイルなので、送信用と受信用に**2個**使用します。
**テストボード**を使用してブレッドボードに接続します。

```
【送信側】3D11-722J #1        【受信側】3D11-722J #2
┌─────────────┐              ┌─────────────┐
│  Test Board │   5cm以上    │  Test Board │
│  X軸 ← 使用 │  ←───────→  │  X軸 ← 使用 │
│  Y軸 (未使用)│              │  Y軸 (未使用)│
│  Z軸 (未使用)│              │  Z軸 (未使用)│
└─────────────┘              └─────────────┘
    DRV8835へ                    MCP6022へ
```

💡 **テストボードについて:**
- 3D11-722JはSMD部品のため、テストボードに実装してから使用します
- テストボードの組み立ては [README.md](README.md) を参照
- KiCad設計ファイル: [3D11_test_Board](../../kicad/3D11_test_Board/)

---

## 全体接続図

```
┌────────────────────────────────────────────────────────────────────────┐
│                        XIAO ESP32C3                                    │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │  D0 (GPIO2) ───────────────→ DRV8835 AIN1 (PWM)                  │ │
│  │  D1 (GPIO3) ───────────────→ DRV8835 AIN2 (GND固定 or 反転PWM)   │ │
│  │                                                                   │ │
│  │  D8 (GPIO8)  ──────────────→ MCP3008 CLK                         │ │
│  │  D9 (GPIO9)  ←────────────── MCP3008 DOUT                        │ │
│  │  D10 (GPIO10) ─────────────→ MCP3008 DIN                         │ │
│  │  D7 (GPIO20) ──────────────→ MCP3008 CS                          │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  3V3 ──────┬───────────────────────────────────────────────┐         │
│             │                                               │         │
│  5V ────────┼───────────────────────┐                       │         │
│             │                       │                       │         │
│  GND ───────┼───────────────────────┼───────────────────────┼─────    │
└─────────────┼───────────────────────┼───────────────────────┼─────────┘
              │                       │                       │
              ▼                       ▼                       ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────┐
│   Vmid生成          │   │   DRV8835           │   │   MCP6022       │
│   (10k/10k分圧)     │   │   (送信ドライバ)    │   │   (受信アンプ)  │
└─────────┬───────────┘   └─────────┬───────────┘   └────────┬────────┘
          │                         │                        │
          │                         ▼                        │
          │               ┌─────────────────┐                │
          │               │ 3D11-722J #1    │                │
          │               │ Test Board      │                │
          │               │ (送信: X軸)     │                │
          │               │ ＋ 共振C        │                │
          │               └─────────────────┘                │
          │                         │                        │
          │                     【磁界】                      │
          │                         │                        │
          │                         ▼                        │
          │               ┌─────────────────┐                │
          │               │ 3D11-722J #2    │────────────────┤
          │               │ Test Board      │                │
          │               │ (受信: X軸)     │                │
          │               └─────────────────┘                │
          │                                                  │
          └──────────────────────────────────────────────────┤
                                                             │
                                                             ▼
                                                   ┌─────────────────┐
                                                   │   MCP3008       │
                                                   │   (ADC)         │
                                                   └─────────────────┘
```

---

## 手順

### Step 1: 受信コイル（3D11-722J #2テストボード）の接続

受信側の3D11-722Jも**テストボード**を使用して接続します。

| テストボード端子 | 接続先 | 備考 |
|------------------|--------|------|
| X+（上部または下部） | MCP6022 +IN B | 信号入力 |
| X-（上部または下部） | Vmid_out | コイルの基準電位 |

💡 **コイルの向き:** どちらの端子を+にしても動作しますが、極性が逆になると位相が180°変わります（振幅Aには影響なし）。

💡 **テストボードの確認:**
- テストボードが正しく組み立てられているか確認
- 各ピン間の導通をテスターで確認
- ショートがないことを確認

### Step 2: 配線の最終確認

以下のチェックリストを確認:

**電源系:**
- [ ] 3.3Vレールに3.3Vが出ている
- [ ] 5Vレールに5Vが出ている
- [ ] 全てのGNDが接続されている

**受信系:**
- [ ] Vmid_outが1.65V
- [ ] MCP6022の出力が1.65V付近（無信号時）
- [ ] MCP3008がSPIで応答する

**送信系:**
- [ ] DRV8835が過熱していない
- [ ] PWMが出力されている

### Step 3: コイルの配置

```
【テスト配置】

   3D11-722J #1            3D11-722J #2
   Test Board              Test Board
   (送信)                   (受信)
  ┌─────────┐             ┌─────────┐
  │  X軸面  │  ← 5cm →   │  X軸面  │
  │         │             │         │
  └─────────┘             └─────────┘
    
※ 同じ軸同士を向かい合わせる
※ 最初は5cm程度から始める
※ 両方ともテストボードに実装済み
```

---

## I/Q処理ファームウェア（XIAO ESP32C3用）

```cpp
#include <SPI.h>
#include <math.h>

// ===== XIAO ESP32C3 ピン設定 =====
#define SPI_SCK  8   // D8
#define SPI_MISO 9   // D9
#define SPI_MOSI 10  // D10
#define SPI_CS   20  // D7
#define PWM_PIN  2   // D0

// ===== 設定値 =====
const int SAMPLE_RATE = 80000;   // 80kHz目標
const int CARRIER_FREQ = 20000;  // 20kHz
const int WINDOW_MS = 2;         // 積分窓長 [ms]

// 計算値
const int SAMPLES_PER_WINDOW = SAMPLE_RATE * WINDOW_MS / 1000;
const float PHASE_INCREMENT = 2.0 * M_PI * CARRIER_FREQ / SAMPLE_RATE;

// ===== グローバル変数 =====
float phase = 0;

// ===== セットアップ =====
void setup() {
  Serial.begin(115200);
  while (!Serial) delay(10);
  
  // SPI初期化
  pinMode(SPI_CS, OUTPUT);
  digitalWrite(SPI_CS, HIGH);
  SPI.begin(SPI_SCK, SPI_MISO, SPI_MOSI, SPI_CS);
  
  // PWM初期化
  ledcSetup(0, 20000, 8);  // チャンネル0, 20kHz, 8bit
  ledcAttachPin(PWM_PIN, 0);
  ledcWrite(0, 128);  // 50% duty
  
  Serial.println("Loutrack EM M0 PoC");
  Serial.println("I,Q,A,phase");
}

// ===== ADC読み取り =====
int readADC(int channel) {
  byte command = 0b11000000 | (channel << 3);
  
  digitalWrite(SPI_CS, LOW);
  SPI.transfer(0x01);
  byte high = SPI.transfer(command);
  byte low = SPI.transfer(0x00);
  digitalWrite(SPI_CS, HIGH);
  
  return ((high & 0x03) << 8) | low;
}

// ===== I/Q処理 =====
void computeIQ(float &I, float &Q, float &A, float &phi) {
  I = 0;
  Q = 0;
  
  unsigned long startMicros = micros();
  
  for (int i = 0; i < SAMPLES_PER_WINDOW; i++) {
    // ADC読み取り（0-1023 → -512〜+511に正規化）
    int raw = readADC(0);
    float sample = (float)(raw - 512);
    
    // 参照波との乗算
    I += sample * cos(phase);
    Q += sample * sin(phase);
    
    // 位相を進める
    phase += PHASE_INCREMENT;
    if (phase > 2 * M_PI) phase -= 2 * M_PI;
  }
  
  unsigned long elapsed = micros() - startMicros;
  
  // 正規化
  I /= SAMPLES_PER_WINDOW;
  Q /= SAMPLES_PER_WINDOW;
  
  // 振幅・位相計算
  A = sqrt(I * I + Q * Q);
  phi = atan2(Q, I) * 180.0 / M_PI;  // 度に変換
}

// ===== メインループ =====
void loop() {
  float I, Q, A, phi;
  computeIQ(I, Q, A, phi);
  
  Serial.printf("%.2f,%.2f,%.2f,%.1f\n", I, Q, A, phi);
  
  // 60Hz更新のため約16.7ms間隔
  delay(16);
}
```

---

## 動作確認

### Step 4: 振幅Aの確認

1. **送信OFF時**（PWMを停止: `ledcWrite(0, 0);`）
   - Aはノイズフロア（小さい値、例: 1〜10）

2. **送信ON時**（PWMを開始: `ledcWrite(0, 128);`）
   - Aが明確に上昇（例: 50〜200以上）

3. **距離変化**
   - コイルを近づける → Aが増加
   - コイルを離す → Aが減少

### Step 5: 共振C最適化

| C値 | A（5cm時） | 備考 |
|-----|------------|------|
| なし | __ | ベースライン |
| 8200pF | __ | |
| 8760pF (8200+560) | __ | 理論最適 |
| 9700pF (8200+1500) | __ | |
| 6800pF | __ | |

**最大のAを示すC値を採用**

### Step 6: 距離・角度スイープ

**距離スイープ:**

| 距離 | A | 備考 |
|------|---|------|
| 3cm | __ | |
| 5cm | __ | |
| 7cm | __ | |
| 10cm | __ | |
| 15cm | __ | |

**角度スイープ:**（コイル面の向きを変える）

| 角度 | A | 備考 |
|------|---|------|
| 0°（正対） | __ | |
| 45° | __ | |
| 90°（直交） | __ | |

---

## 成功判定

以下を満たせば**M0達成**:

| # | 条件 | 達成 |
|---|------|------|
| 1 | 送信ON時、Aが安定（標準偏差 < 平均の10%） | ☐ |
| 2 | 距離を変えるとAが単調変化 | ☐ |
| 3 | 送信ON/OFFでAに10倍以上の差 | ☐ |
| 4 | 1フレーム（16.7ms）内にI/Q算出完了 | ☐ |

---

## トラブルシューティング

### Aが安定しない（ノイズが大きい）

| 原因 | 対策 |
|------|------|
| 送信ノイズの回り込み | 送受を離す、GND一点接続を徹底 |
| 積分窓長が短い | WINDOW_MSを2→5msに増やす |
| サンプルレートが低い | SPIクロックを上げる |

### Aが常に小さい

| 原因 | 対策 |
|------|------|
| 共振Cが合っていない | 別のC値を試す |
| コイルの向きが悪い | 同じ軸を向かい合わせる |
| 距離が遠すぎる | 3cm程度まで近づける |
| アンプゲインが低い | Rfを増やす（22kΩでGain≈23） |

### Aが飽和（常に最大）

| 原因 | 対策 |
|------|------|
| 信号が強すぎ | コイルを離す |
| ADCが飽和 | ADC値が0か1023に張り付く → ゲインを下げる |

---

## 次のステップ

✅ M0達成おめでとうございます！

次のフェーズ:
- **M1**: 3軸TDM実装
  - 3D11-722JのY軸、Z軸を追加
  - DRV8835 #2を追加
  - TDMスロット制御実装

詳細は `documents/requirements/specification_v0.9.md` のセクション10を参照


