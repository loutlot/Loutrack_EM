# M0 PoC トラブルシューティング

## よくある問題と対策

---

## 1. 電源系の問題

### 症状: XIAO ESP32C3が起動しない

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| USBケーブルの問題 | 別のケーブルで試す | データ転送対応ケーブルを使用 |
| ショート | テスタで3.3V-GND間を確認 | 配線を見直し、ショートを解消 |
| 過電流 | USB給電元を確認 | PCポートを変える、USBハブを避ける |

### 症状: 3.3Vが出ない

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| XIAO ESP32C3が動作していない | LEDを確認 | リセット、再書き込み |
| 過負荷 | 回路を切り離して測定 | 負荷を減らす |

### 症状: Vmidが1.65Vにならない

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| 抵抗値の間違い | テスターで抵抗を測定 | 正しい抵抗に交換 |
| 分圧抵抗の接続ミス | 回路を確認 | 3.3V→10k→Vmid→10k→GND を確認 |
| 負荷が重い | Vmidバッファを確認 | MCP6022のVmidバッファを先に構成 |

---

## 2. 受信アンプ（MCP6022）の問題

### 症状: 出力が0Vまたは3.3Vに張り付く

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| 発振している | オシロで波形確認 | 47pFを追加・増量 |
| 入力がオープン | 入力電圧を確認 | +INをVmidに接続 |
| ICの向きが逆 | ピン1の位置を確認 | ICを正しい向きに挿し直し |

### 症状: ゲインが想定と異なる

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| Rf/Rgの値が違う | テスターで確認 | 正しい抵抗値に交換 |
| RgがVmidに接続されていない | 配線確認 | RgをVmid_outに接続 |
| 帯域制限 | 周波数を下げてテスト | 47pFを減らす（発振注意） |

### 症状: ノイズが多い

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| デカップリング不足 | コンデンサの有無確認 | 0.1µFを追加 |
| 配線が長い | 配線を確認 | 配線を短くする |
| GNDループ | GND配線を確認 | 一点接続に変更 |

---

## 3. ADC（MCP3008）の問題

### 症状: 常に0が返る

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| SPI接続ミス | 配線確認 | CLK, MOSI, MISO, CSを確認 |
| CSがHighのまま | CSピンを確認 | コードでCSをLowにしているか確認 |
| 電源が入っていない | VDD電圧確認 | 3.3Vが来ているか確認 |

### 症状: 値が不安定

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| VREFデカップリング不足 | コンデンサ確認 | VREF-AGND間に0.1µF追加 |
| 入力インピーダンスが高い | 入力源を確認 | アンプ経由で入力 |
| SPIクロックが速すぎ | クロック設定確認 | クロックを下げる（1MHz以下から試す） |

### 症状: 値がVmid（512）付近にならない

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| アンプ出力がVmidでない | アンプ出力を測定 | モジュール2を再確認 |
| CH0以外を読んでいる | コードを確認 | チャンネル指定を確認 |

---

## 4. 送信（DRV8835）の問題

### 症状: DRV8835が熱くなる

⚠️ **即座に電源を切ってください！**

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| 出力がショート | AOUT1-AOUT2間を確認 | コイル接続を確認 |
| 過電流 | 電源供給能力を確認 | USB電源を確認、コイル巻数を増やす |
| MODEの設定ミス | MODE電圧を確認 | MODEを3.3V（Hi）に |

### 症状: 波形が出ない

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| PWMが出力されていない | GPIO電圧を確認 | XIAO ESP32C3のPWMコードを確認 |
| VMが来ていない | VM電圧を確認 | 5V供給を確認 |

### 症状: 受信側で信号が見えない

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| 共振がズレている | C値を変えてテスト | 共振C探索を実施 |
| コイルの向きが悪い | 配置を変えてテスト | 同じ軸を向かい合わせる |
| 距離が遠い | 近づけてテスト | 3cm程度まで近づける |
| アンプゲインが低い | アンプ出力を確認 | Rfを増やす |

---

## 5. I/Q処理の問題

### 症状: Aが常に0または小さい

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| ADC値が変化していない | 生のADC値をログ | 受信系を確認 |
| 参照周波数がズレている | CARRIER_FREQを確認 | 20000（Hz）に設定 |
| サンプルレートが低い | 実測サンプルレート確認 | SPIクロックを上げる |

### 症状: Aが不安定

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| 積分窓長が短い | WINDOW_MSを確認 | 2→5msに増やす |
| ノイズが大きい | 生波形を確認 | アナログ回路のノイズ対策 |
| 周波数ドリフト | 長時間観測 | NCO追従アルゴリズム追加 |

### 症状: Aが飽和（常に最大）

| 原因 | 確認方法 | 対策 |
|------|----------|------|
| 信号が強すぎ | ADC生値を確認 | コイルを離す、ゲインを下げる |
| ADCが飽和 | ADC値が0か1023に張り付く | アンプゲインを下げる |

---

## 6. 部品の確認方法

### 抵抗のカラーコード

| 値 | カラーコード（4本帯） | カラーコード（5本帯・0.1%） |
|----|----------------------|----------------------------|
| 1kΩ | 茶-黒-赤-金 | 茶-黒-黒-茶-茶 |
| 10kΩ | 茶-黒-橙-金 | 茶-黒-黒-赤-茶 |

### コンデンサの表記

| 表記 | 値 |
|------|-----|
| 104 | 0.1µF (100nF) |
| 103 | 0.01µF (10nF) |
| 822 | 8200pF |
| 682 | 6800pF |
| 152 | 1500pF |
| 561 | 560pF |
| 470 | 47pF |

### ダイオードの向き（BAT43）

```
バンド（帯）がある側がカソード（K）

   アノード(A)    カソード(K)
      │              │
   ───│◁─────────────│───
      │      帯      │
```

---

## 7. XIAO ESP32C3固有の注意点

### ピン配置の確認

```
        ┌─────────────────┐
        │   XIAO ESP32C3  │
        │                 │
   D0 ──┤ GPIO2    5V    ├── 5V出力
   D1 ──┤ GPIO3    GND   ├── GND
   D2 ──┤ GPIO4    3V3   ├── 3.3V出力
   D3 ──┤ GPIO5    GPIO10├── D10 (MOSI)
   D4 ──┤ GPIO6    GPIO9 ├── D9  (MISO)
   D5 ──┤ GPIO7    GPIO8 ├── D8  (SCK)
   D6 ──┤ GPIO21   GPIO20├── D7  (CS)
        └─────────────────┘

左側: D0-D6 (GPIO2,3,4,5,6,7,21)
右側: 5V, GND, 3V3, D10-D7 (GPIO10,9,8,20)
```

### SPI初期化の注意

ESP32C3では`SPI.begin()`の引数でピンを指定:

```cpp
SPI.begin(SPI_SCK, SPI_MISO, SPI_MOSI, SPI_CS);
// SPI.begin(8, 9, 10, 20); でも可
```

### GPIO2の注意

GPIO2はブート時にプルアップされている場合があります。
PWMに使用する場合は問題ありませんが、他の用途では注意。

---

## 8. 3D11-722Jコイルの注意点

### ピン配置の確認

コイルの実物のマーキングを確認してください。
一般的な3軸コイルのピン配置例:

```
┌─────────────────────┐
│  ●1  ●2  ●3  ●4   │  
│                     │
│      3D11-722J      │
│                     │
│  ●5  ●6  ●7  ●8   │
└─────────────────────┘

例: 
1-2: X軸
3-4: Y軸
5-6: Z軸
```

### インダクタンス確認

テスターのインダクタンスモードで測定:
- 期待値: 約7.2mH（各軸）
- 許容範囲: 6〜9mH

---

## 9. 測定のコツ

### テスターでの電圧測定

1. 黒リード（COM）をGNDに固定
2. 赤リードで測定点に触れる
3. 値が安定するまで待つ

### 導通チェック

1. テスターを導通モード（ブザーマーク）に
2. 両端に触れて「ピー」と鳴れば導通
3. 電源を切った状態で行う

### ショートチェック

1. 電源投入前に、3.3V-GND間、5V-GND間を測定
2. 数kΩ以上あればOK（数Ωはショートの可能性）

---

## 10. 助けを求める際の情報

問題が解決しない場合、以下の情報をまとめてください:

1. **症状:** 何が起きているか
2. **期待動作:** 何が起きるべきか
3. **測定値:** テスターで測った電圧など
4. **写真:** 配線の様子
5. **コード:** 使用しているファームウェア
6. **シリアル出力:** Serial.printの出力


